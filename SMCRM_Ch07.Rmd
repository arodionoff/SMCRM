---
title: "Statistical Methods in Customer Relationship Management"
subtitle: "Chapter 7. Customer Win-Back"
author: "Alexander Rodionov"
date: "7 июля 2018 г."
output: 
  html_document:
    highlight: tango 
    theme: readable
    code_folding: hide
    fig_caption: yes
    fig_height: 4
    fig_width: 6.3
    toc: yes
    toc_float: no
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 120)
```

Мы завершаем рассматриваем в **R** примеры **SAS** на наборах данных из книги Kumar V., Petersen Andrew J. "Statistical Methods in Customer Relationship Management".

# Глава 7. Вернуть потребителей снова

Менеджеры обычно считают, что оттока клиентов - это конец жизненного цикла клиента. Но это не должно быть завершением жизненного цикла. Компании все еще могут вернуть потерянных клиентов и дать им вторую жизнь. В отличие от новых клиентов, у потерянных клиентов есть определенные знания о продуктах и услугах компании и они имеют собственное мнение об атрибутах и функциях продуктов и услуг. С одной стороны, легче подойти к потерянным клиентам, так как они знакомы с компанией. С другой стороны, потерянные клиенты часто переключают продавцов, потому что они не удовлетворены продуктом, поэтому не всегда легко изменить свое отношение и убедить их вернуться. Авторы также должны рассмотреть вопрос о том, стоит ли возвращать клиентов обратно в фирму - не все клиенты стоят того, чтобы оставить их после выхода.

Как только авторы определили, когда клиент, скорее всего, уйдет в отток (см. [шестую главу](https://rpubs.com/A_Rodionoff/SMCRM_Ch06) для подробного анализа определения вероятности оттока), следует решить, будет ли в интересах компании пытаться вернуть клиента. Итак, есть несколько ключевых вопросов, на которые следует ответить. К ним относятся:

* Следует ли вмешиваться в уход клиентов?

* Как следует подойти к клиентам, чтобы вернуть их?

Ответы на каждый из этих вопросов будут способствовать оптимальной стратегии возврата клиентов. В этой области было проведено несколько исследований, хотя исследования в области защиты клиентов все еще недостаточны. Чтобы обеспечить полное понимание того, как моделировать обратную связь с клиентами, авторы предлагают рассмотривать проблемы в исследованиях один за другим вместе с соответствующими методами моделирования. Авторы также представят эмпирический пример, который продемонстрирует, как применять эти знания к представительной выборке клиентов из фирмы B2C.

Как и в моделях привлечения клиентов и моделях удержания клиентов, первым вопросом, на который нужно ответить, является вопрос о том, вступают ли клиенты с фирмой в договорные или внедоговорные отношения. В большинстве случаев это определяет тип статистической модели, который необходимо использовать для получения информации о данных.

## Данные для эмпирического примера

В этой главе авторы дают описание основных этапов моделирования, которое пытается ответить на каждый ключевой вопрос исследования, поднятый в начале главы. Авторы приводят эмпирический пример, который покажет, как образцы данных могут использоваться для ответа на эти ключевые вопросы исследования. Для эмпирического примера авторы предоставляем набор данных под названием `customerWinBack`. В этом наборе данных содержится репрезентативная выборка из 500 текущий и бывших клиентов типичной фирмы **B2C**. Данные включают следующие 10 переменные:

| Переменные      | Описание                                                                             |
|:--------------- |:-------------------------------------------------------------------------------------|
| Reacquire       | **1**, если клиент был вновь привлечен, **0** в противном случае |
| Duration_2      | Время в днях, когда клиент стал вторично активным или продолжает быть клиентом |
| SCLV            | Прогноз ценности клиента на втором цикле жизни. Это **0**, если клиента не зашел вновь |
| Duration_1      | Время в днях, когда клиент оставался активным на первом цикле сотрудничества с фирмой |
| Offer           | Стоимость предложения, предоставленного клиенту для повторного привлечения |
| Duration_lapse  | Время в днях, между тем как клиент ушел в отток и затем получив предложение о возвращении |
| Price_Change    | Увеличение (или уменьшение) цены подписки второго жизненного цикла против первого цикла |
| Gender          | **1**, если клиент является мужчиной, **0**, если клиент является женщиной |
| Age             | Возраст клиента на момент получения предложение о возвращении к сотрудничеству с фирмой |

Эти данные будут использованы для эмпирического примера, который поможет понять драйверы и вероятность повторного возврата клиентов.

```{r Ch07: customer WinBack - Data}
library('tidyverse')
library('caret')
library('car')
utils::data('customerWinBack', package = 'SMCRM')

# Check for Class Imbalances
writeLines("Distribution Variable 'customerWinBack' by Reacquisition factor")
customerWinBack$reacquire %>%
  factor() %>%
    table() # %>%
      # prop.test() 

```

Следует отметить, что авторы авторы получили случайную выборку, которую сложно счесть сбалансированной по признаку `reacquire`. Поэтому при построении моделей авторам было важно учитывать этот явление. Однако они, как и в предыдущих главах, упустили этот моменте своем анализе.

## Эмпирический пример: Возращение потребителей снова

Чтобы понять, нужно ли пытаться вернуть потерянного клиента, нам необходимо разработать набор моделей, которые описывают процесс повторного привлечения (WinBack) и второго жизненного цикла клиента. Этот процесс будет включать в себя три разные модели: модель *повторного привлечения*, модель *продолжительности жизни клиента во втором цикле* и модель *CLV второго цикла жизни*. Как только авторы смогут получим результаты от трех моделей, появиться лучшее понимание того, как повторно приобретать клиентов, а потерянные клиенты заслуживают повторного привлечения. Авторы предлагают оценить три модели:

$$ \displaystyle \large  \begin{array}{ll}
y_{L_i} = \begin{cases}
\beta'_L x_{Li} + \gamma' y_{Di} + \varepsilon_{Li} & {\text{if}}\ z_i = 1 \\
0 & {\text{в противном случае}} {} \\ 
\end{cases} (уравнение \enspace CLV \enspace второго \enspace цикла \enspace жизни)
\end{array} \hspace{.5 in} [1] $$

$$ \displaystyle \large \hspace{.5 in} \begin{array}{ll}
y_{D_i} = \begin{cases}
\beta'_D x_{Di} + \varepsilon_{Di} & {\text{if}}\ z_i = 1 \\
0 & {\text{в противном случае}} {} \\ 
\end{cases} (уравнение \enspace CLV \enspace продолжительности \enspace жизни \enspace во \enspace втором \enspace цикле)
\end{array} \hspace{.5 in} [2] $$

$$ \displaystyle \large \hspace{2.5 in} z^*_{i} = \alpha'v_i + \mu_i \hspace{.5 in}  (уравнение \enspace возвращения \enspace клиентов)$$

$$ \displaystyle \large \begin{array}{ll}
z_{i} = \begin{cases}
1 & {\text{if}}\ z_i^* > 0  \hspace{.5 in} [3]\\
0 & {\text{if}}\ z_i^* \le 0 {} \\ 
\end{cases}
\end{array} $$

где $z^*_{i}$ - скрытая переменная, указывающая на полезность потребителя *i* для участия во втором цикле с фирмой;

- $z_{i}$ - индикаторная переменная, показывающая, будет ли клиент *i *повторно привлечен ($z_{i}$ = 1) или нет ($z_{i}$ = 0);

- $v_{i}$ - вектор ковариатов влияющих на повторное привлечение клиента *i*;

- $y_{D_i}$ - продолжительность второго жизненного цикла отношений клиента с фирмой;

- $x_{D_i}$ - вектор ковариатов, влияющий на продолжительность второго жизненного цикло клиента;

- $y_{L_i}$ - CLV второго жизненного цикла клиента *i*;

- $x_{L_i}$ - вектор ковариатов, влияющих на CLV второго жизненного цикла клиента *i*;

- $\alpha, \beta_L, \beta_D$ - вектора параметров модели *повторного привлечения*, модели *продолжительности жизни клиента во втором цикле* и модели *CLV второго цикла жизни* соответственно;

и $\mu_i, \varepsilon_{Di} \enspace и \enspace \varepsilon_{Li}$ -  случайные ошибки моделей.

Учитывая, что структура моделирования носит рекурсивный характер, авторы предлагают ее оценить поэтапно. В этом эмпирическом примере будут три подраздела (аналогичные оценке в [шестой главе](https://rpubs.com/A_Rodionoff/SMCRM_Ch06)). В первом подразделе будет описана и оценена модель *повторного привлечения*, вторая будет описывать и оценивать *продолжительности жизни клиента во втором цикле*, а третья будет описывать и оценивать  модель *CLV второго цикла жизни*.

### Модель *повторного привлечения* {.tabset}

Ключевой вопрос, который авторы хотят ответить в отношении повторного привлечения клиентов, заключается в том, можем ли определиться, какие будущие перспективы имеют наивысшую вероятность повторного привлечения. Для этого сначала нужно знать, какие ранее потерянные клиенты были приобретены, а какие нет. В наборе данных, предоставленном для этой главы, имеется бинарная переменная, которая идентифицирует, был ли ранее потерянный клиент повторно подключен фирмой (и, следовательно, снова стал клиентом) и набор драйверов, которые могут помочь объяснить решение клиента о воссоединении с фирмой. Случайная выборка из 500 ранее потерянных клиентов (некоторые из которых стали клиентами снова) была взята из фирмы **B2C**. Информация, необходимая для нашей модели *повторного привлечения*, включает следующий список переменных:

| Переменные      | Описание                                                                             |
|:--------------- |:-------------------------------------------------------------------------------------|
| **Зависимая переменная** |  |
| Reacquire       | **1**, если клиент был вновь привлечен, **0** в противном случае |
| **Предикторы**          |  |
| Duration_1      | Время в днях, когда клиент оставался активным на первом цикле сотрудничества с фирмой |
| Offer           | Стоимость предложения, предоставленного клиенту для повторного привлечения |
| Duration_lapse  | Время в днях, между тем как клиент ушел в отток и затем получив предложение о возвращении |
| Price_Change    | Увеличение (или уменьшение) цены подписки второго жизненного цикла против первого цикла |
| Gender          | **1**, если клиент является мужчиной, **0**, если клиент является женщиной |
| Age             | Возраст клиента на момент получения предложение о возвращении к сотрудничеству с фирмой |

Во-первых, нужно смоделировать вероятность того, что отношения фирмы с клиентом будут восстановлены. Поскольку наша зависимая переменная (`Reacquire`) является двоичной и нужна оценивать две другие последовательные модели  (как нормально распределенные), то следует выбирать пробит-регрессию для этой модели. Выбор логистической регрессии потребовал бы, чтобы мы преобразовали выход модели, прежде чем интегрировать результаты с двумя другими уравнениями. В этом случае переменная `y` является `Reacquire`, а переменные `x` представляют ряд независимых переменных в нашей базе данных. Когда запускается пробит-регрессия, получаем следующий результат:

#### Probit

```{r Ch07 : Probit Regression}
# Fit Probit Model for Customer Reacquisition by Authors
# https://stats.idre.ucla.edu/sas/dae/probit-regression & https://stats.idre.ucla.edu/r/dae/probit-regression
Ch07.reacq <- glm(reacquire ~ duration_1 + offer + duration_lapse + gender + age,
             data = customerWinBack, family = binomial(link = 'probit'))
summary(Ch07.reacq)
writeLines(sprintf("-2 Log L of Intercept and Only Covariates: %.3f", -2 * logLik(Ch07.reacq)[1]))
writeLines(sprintf("                  AIC (smaller is better): %.3f", extractAIC(Ch07.reacq)[2]))

writeLines("\n Wald test of predictors")
car::Anova(Ch07.reacq, type="II", test="Wald")
writeLines("\n Variance Inflation Factors - if vif() > 2  - feature has multicollinearity with others")
car::vif(Ch07.reacq) # Variance Inflation Factors - if vif() > 2 - feature has multicollinearity 

writeLines("\n Probit Model: Association of Predicted Probabilities and Observed Responses \n")
prob <- predict(Ch07.reacq, newdata = customerWinBack, type = "response") 
caret::confusionMatrix(data = ifelse(prob > 0.5, "1", "0") %>% factor,
                       reference = customerWinBack$reacquire %>% factor,
                       positive = "1", mode = "everything")
```

Как видно из результатов, пять из шести (включая засчитанный авторами свободный член) независимых переменных значимы при *p-значении* 5% или выше - единственной несущественной переменной является `Gender`. Во-первых, это означает, что чем дольше первоначальные отношения связывали клиента с фирмой (`Duration_1`), тем выше вероятность возвращения клиента вновь. Во-вторых, результаты показывают, что чем выше `Offer`, сделанное для бывшего клиента, то, тем вероятнее, повторное привлечение. В-третьих, результаты показывают, что чем дольше время, прошедшее с момента завершения первого цикла работы с клиентом (`Duration_Lapse`), тем менее вероятно, что клиент будет повторно приобретен. Наконец, результаты показывают, что чем старше клиент (`Age`), тем меньше вероятность того, что клиент будет восстановлен.

Теперь, когда мы определили драйверы восстановления клиента, следует использовать выводы модели для определения предсказательной точности авторской модели. Для этого нужно использовать оценки, полученные нами по модели  *повторного привлечения*, чтобы помочь определить предсказуемую вероятность того, что каждый клиент будет восстановлен. 

#### Probit (AR version)

Авторы обсуждают в книге как правильнее учесть несбалансированность двух классов предлагая для этого экстравагантные подходы. Я рекомендую обратиться к хорошо зарекомендовавшему способу взвешивания классов, который вкупе с 25-ти кратным бустингом на имеющихся данных и выбором коэффициент **Cohen's Kappa** в качестве критерия отбора наиболее точной модели, существенно увеличивает устойчивость модели.

```{r Ch07 : Probit Improved, warning=FALSE}
# Fit Probit Regression Model for Customer Reacquisition (Improved)
uno = 'probit'

# Weights of cases to resolve Class Imbalances Problem
weight.cases <- customerWinBack$reacquire
for(val in unique(weight.cases)) {weight.cases[weight.cases==val]=
    1/sum(weight.cases==val)*length(weight.cases)/2} # normalized to sum to length(samples)

set.seed(2018) #From random.org
(Ch07pr.AR <- train(factor(reacquire) ~ duration_1 + offer + duration_lapse + gender + age,
             data = customerWinBack, metric = 'Kappa', weights = weight.cases, 
             method = "glm", family = binomial(link = uno)))#,
                  # trControl = trainControl(method = "none", number = 1)))
summary(Ch07pr.AR)
# Odds Ratio Estimates and 95% CI
writeLines("\n Odds Ratio Estimates and 95% CI")
car::Confint(Ch07pr.AR$finalModel) %>%
  exp() %>%
    arm::pfround(digits = 3)

# Logistic regression diagnostics
writeLines("\n Wald test of predictors")
car::Anova(Ch07pr.AR$finalModel, type="II", test="Wald")
writeLines("\n Variance Inflation Factors - if vif() > 2  - feature has multicollinearity with others")
car::vif(Ch07pr.AR$finalModel) # Variance Inflation Factors - if vif() > 2  - feature has multicollinearity
writeLines("\n Variable Importance for Model \n")
caret::varImp(Ch07pr.AR) %>% .$importance %>% print.AsIs()

# Create the scatter plots Probit versus model predictors
predictors <- Ch07pr.AR$coefnames
Ch07pr.AR$trainingData %>%
  dplyr::select(one_of(predictors)) %>%
    mutate(link = predict(Ch07pr.AR$finalModel, newdata = customerWinBack, type = "link")) %>%
      gather(key = "predictors", value = "predictor.value", -link) %>%
        ggplot(aes(predictor.value, link))+
          geom_point(size = 0.5, alpha = 0.5) +
          geom_smooth(method = "loess") +
          facet_wrap(~ predictors, scales = "free_x") +
          ylab(stringr::str_to_title(uno))

# Plot matrix of statistical model diagnostics
GGally::ggnostic(Ch07pr.AR$finalModel, title = paste(paste(formula(Ch07pr.AR)[c(2, 1, 3)], collapse = " ")))

# wide variety of diagnostic plots for checking the quality of regression fit
# https://bookdown.org/jefftemplewebb/IS-6489/logistic-regression.html
car::influenceIndexPlot(Ch07pr.AR$finalModel)

writeLines("\n Improved Probit Model: Association of Predicted Probabilities and Observed Responses \n")
caret::confusionMatrix(data = predict(Ch07pr.AR, newdata = customerWinBack),
                       reference = customerWinBack$reacquire %>% factor,
                       positive = "1", mode = "everything")

qplot(`Observed Classes`, `Predicted Classes`, 
      data=bind_cols(`Observed Classes`= factor(customerWinBack$reacquire),
                     `Predicted Classes` = predict(Ch07pr.AR, newdata = customerWinBack)),  
      colour= `Observed Classes`, geom = c("boxplot", "jitter"),
      main = "Predicted Classes vs. Observed Classes", xlab = "Observed Classes", ylab = "Predicted Classes")
```

В результате я получаю значительнее устойчивее модель, которая имеет большую точность против авторской за счет использования корректных весов бинарного класса ("Kappa" = `r sprintf("%.4f", caret::confusionMatrix(predict(Ch07pr.AR, newdata = customerWinBack) %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$overall %>%  .["Kappa"])`). Правда, небольшое снижение чуствительности модели становится платой за её устойчивость.

### Как это использовать?

Как видно из таблицы, авторская модель на этих данных точно предсказывает хорошо - `r sprintf("%.1f", caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$byClass %>%  .["Specificity"] * 100)`% клиентов (коэффициент *специфичности*), которые решили не возвращаться (`r caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$table %>% .[1, 1]`/`r customerWinBack$reacquire %>% table() %>% as.vector %>%  .[1]`) и `r sprintf("%.1f", caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$byClass %>%  .["Sensitivity"] * 100)`% клиентов (коэффициент *чуствительности*), которые решили возвращаться (`r caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$table %>% .[2, 2]`/`r customerWinBack$reacquire %>% table() %>% as.vector %>%  .[2]`). Для предсказания по клиентом, которые решили повторно приобрести продукт и для прогнозирования клиентов, которые решили не повторно приобретать продукт, это значительное увеличение прогностической способности *наивной* модели случайных догадок, которая была бы только на `r sprintf("%.1f", caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$overall %>% . ["AccuracyNull"]*100)`% (см. показатель "`No Information Rate`" в *Матрице ошибок*) для этого набора данных , Чтобы определить общую прогнозируемую производительность модели, мы рассмотрим диагональ и видим, что в целом наша точность предсказания (коэффициент *аккуратности*) составляет `r sprintf("%.1f", caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$overall %>%  .["Accuracy"] * 100)`% (`r caret::confusionMatrix(ifelse(prob > 0.5, "1", "0") %>% factor, customerWinBack$reacquire %>% factor, positive = "1") %>% .$table %>% as.vector %>% .[c(1, 4)] %>%  sum`/`r nrow(customerWinBack)`). Учитывая, что модель в целом предсказывает лучше, чем *наивная* модель случайных догадок, можно определить, что предсказание по модели хорошее.

В результате теперь стало известно, как анализировать прошлую продолжительность жизни клиента; время, прошедшее с того момента, когда клиент отказался от сотрудничества с фирмой; уровень предложения, который предоставляется клиенту для стимулирования возвращения, а демографические характеристики клиента могут либо увеличить, либо уменьшить вероятность возвращения вновь.

### Модель *продолжительности жизни клиента во втором цикле*

Второй этап этого процесса - оценить модель *продолжительности жизни клиента во втором цикле*. Цель этой модели - понять драйверы, которые описывают продолжительность времени, когда клиент, вероятно, будет клиентом во второй раз, зависит от того, что произошло ранее. Таким образом, уравнение принимает следующий формат:

$$ \displaystyle \large E(Duration \text _ 2) = P(Reacquisition = 1) * E(Duration \text _ 2 | Reacquisition = 1) \hspace{.5 in} [4]$$

Это уравнение показывает, что ожидаемая *вторичной продолжительность* (`Duration_2`) является функцией вероятности повторного приобретения клиента, умноженной на ожидаемое значение *вторичной продолжительности* при условии, что клиент был повторно привлечен. Если бы мы просто выполняли регрессию с `Duration_2` как зависимую переменную и игнорировали вероятность того, что клиент прочитает, мы получим смещенные оценки из-за возможного *смещения выборки*.

Смещение выборки (англ. "`Sample Selection Bias`")  является проблемой, которая распространена во многих маркетинговых задачах и должна быть статистически учтена во многих процессах моделирования. Если у клиента есть выбор, нужно ли повторно приобретать продукт, прежде чем принимать решение о том, как долго будут длится вторый цикл связь, то наличие выбора о повторном привлечение надо учитывать в модели. Если бы авторы проигнорировали этот выбор, то бы сместили оценки в модели, и были бы получены менее точные предсказания для значения `Duration_2`. Чтобы учесть эту проблему, авторы предлагают иметь возможность предсказывать значение как вероятности `Reacquisition` (что авторы уже на первом шаге этого примера), так и ожидаемое значение `Duration_2`, учитывая, как долго клиент будет сотрудничать с фирмой предже, чем вновь будет потерян.

Наконец, авторы хотим оценить регрессионную модель для `Duration_2` и включить переменную $\lambda$ в качестве дополнительной независимой переменной. Это делается простым способом, используя следующее уравнение:

$$ \displaystyle \large Duration \text _ 2 = \gamma' \alpha + \mu \lambda + \varepsilon. \hspace{.5 in} [5] $$

В этом случае `Duration_2` является значением  *вторичной продолжительность*, $\gamma$ является матрицей переменных, используемой для объяснения значения `Duration_2`, $\alpha$ - коэффициенты для независимых переменных, $mu$ - коэффициент *обратного отношения Миллса*, l - обратный коэффициент Миллса, а $\varepsilon$ - это случайная ошибка модели. Таким образом, для этого примера мы будем использовать следующий список переменных:

| Переменные      | Описание                                                                             |
|:--------------- |:-------------------------------------------------------------------------------------|
| **Зависимая переменная** |  |
| Duration_2      | Время в днях, когда клиент стал вторично активным или продолжает быть клиентом |
| **Предикторы**          |  |
| Duration_1      | Время в днях, когда клиент оставался активным на первом цикле сотрудничества с фирмой |
| Offer           | Стоимость предложения, предоставленного клиенту для повторного привлечения |
| Duration_lapse  | Время в днях, между тем как клиент ушел в отток и затем получив предложение о возвращении |
| Price_Change    | Увеличение (или уменьшение) цены подписки второго жизненного цикла против первого цикла |
| Gender          | **1**, если клиент является мужчиной, **0**, если клиент является женщиной |
| Age             | Возраст клиента на момент получения предложение о возвращении к сотрудничеству с фирмой |
| *Lambda* ($\lambda$) | Рассчитанное *обратное отношение Миллса* из модели повторного привлечения клиента |

Когда авторы оценивали второй этап модели, они получили следующие оценки параметров второго из двух уравнений (оценки параметров для модели *повторного привлечения* подробно описаны в первой части этого примера):

```{r Ch07: Second Duration Model}
# Fit Linear Regression Model for Second Duration by Authors
# https://stats.idre.ucla.edu/sas/webbooks/reg/

# SAS Code: imr_win = (pdf(’Normal’,xb_probit))/(probnorm(xb_probit));
xbeta <- predict(Ch07.reacq, newdata = customerWinBack, type = "link")
customerWinBack <- customerWinBack %>% 
  mutate(imr_win = dnorm(xbeta) / pnorm(xbeta)) #  Cumulative normal pdf
    
(Ch07.2Dur <- lm(duration_2 ~ duration_1 + offer + duration_lapse + price_change + gender + age + imr_win,
                 data = filter(customerWinBack, reacquire == 1) )) %>%
  summary

writeLines("Variance Inflation Factors - if vif() > 2  - feature has multicollinearity with others")
car::vif(Ch07.2Dur) # Variance Inflation Factors - if vif() > 2 - feature has multicollinearity 

```

Как видно из результатов второй авторской модели коэффициент $\lambda$, т.е. `imr_win` является положительным и значительным. Это означает, что существует потенциальная *проблема смещения выбора*, поскольку коэффициент ошибки нашего уравнения выбора положительно коррелирует с погрешностью авторского уравнения линейной регрессии. Также видно, что все другие предикторы модели `Duration_2` значитимы, что означает, что мы, вероятно, обнаружены многие из драйверов *вторичной продолжительности*.

Коэффициент `Duration_1` является положительным, предполагается, что чем дольше срок жизни клиента с фирмой, тем дольше будет вторая жизнь, которую клиент будет продолжать с фирмой. Мы считаем, что `Offer` является положительным, предполагая, что чем выше сумма предложения (т. е. чем больше стимул), тем дольше будет *вторичная продолжительность жизни*. Авторы нашли, что чем дольше времени, клиент провел после первого сотрудничества с фирмой (`Duration_lapse`), тем короче *вторичная продолжительность* жизни с фирмой. Обнаруживается, что когда цена, которую клиент платит за продукт во втором цикле жизни, ниже, чем в первом (`Price_Change < 0`), то *вторичная продолжительность жизни клиента* больше. Наконец, становится известным, что у клиентов мужского пола или у более молодых клиентов больше шансов иметь более продолжительный вторую цикл, чем у женщин или пожилых клиентов.

Следующий шаг - предсказать значение `Duration_2`, чтобы увидеть, насколько хорошо наша модель сравнивается с фактическими значениями. Делается это начиная с уравнения ожидаемой продолжительности в начале этого примера:

$$ \displaystyle \large E(Duration \text _ 2) = P(Reacquisition = 1) * E(Duration \text _ 2 | Reacquisition = 1) = Ф(X' \beta) * \gamma' \alpha + \mu \lambda. \hspace{.5 in} [5]$$
В этом случае $Ф$ является кумулятивной функция вероятности нормального распределения;

- $X$ является матрицей независимых значений переменных из уравнения `Reacquisition`;

- $\beta$ - вектор коэффициентов предикторов из уравнения `Reacquisition`;

- $\gamma$ - матрица предикторов из уравнения `Duration_2`;

- $\alpha$ - вектор коэффициентов предикторов из уравнения `Duration_2`;

- $\mu$ - коэффициент для обратного отношения Миллса;

- $\lambda$ - обратное отношение Миллса.

```{r Ch07 : Error of Second Duration Model}
# Computing the Mean Absolute Deviation (MAD) and Mean Absolute Percent Error (MAPE)
# SAS Code: pred_dur2 = probnorm(xb_probit)*(xbeta_duration2);

with(filter(customerWinBack, reacquire == 1), {
  pred_dur2 <- pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) *
               predict(Ch07.2Dur, newdata = filter(customerWinBack, reacquire == 1))
  # mad = mean(abs(abs(duration_2 - pred_dur2));
  writeLines(sprintf("Mean Absolute Deviation (MAD): %.2f дней", mean(abs(duration_2 - pred_dur2))))
  
  # mape = mean(abs(duration_2 - pred_dur2)/duration_2);
  writeLines(sprintf("Mean Absolute Percent Error (MAPE): %.3f %% \n", mean(abs(duration_2 - pred_dur2) /
                                                                              duration_2) * 100))
})

with(customerWinBack, {
  writeLines(sprintf("Mean `Duration_2` for Naive Model: %.2f дней \n", mean(duration_2)))
  
  # mad1 = mean(abs(duration_2 - mean(duration_2));
  mad1 <- mean(abs(duration_2 - mean(duration_2)))
  writeLines(sprintf("Naive Mean Absolute Deviation (MAD1): %.2f дней", mad1))
  
  # mape1 = mean(abs(duration_2 - mean(duration_2))/duration_2);
  mape1 <- mean(abs(duration_2 - mean(duration_2)) / duration_2) * 100
  writeLines(sprintf("Naive Mean Absolute Percent Error (MAPE1): %.3f %%", mape1))
  
  })
```

Авторы проверя точность второй модели рассчитывают по клиентам, что откливнулдись на призыв к возвращению, но пишут в книге, что для всех клиентов, что MAD = `r sprintf("%.2f", mean(abs(filter(customerWinBack, reacquire == 1)$duration_2 - pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) * predict(Ch07.2Dur, newdata = filter(customerWinBack, reacquire == 1)))))`. Это означает, что в среднем каждое из авторских прогнозов `Duration_2` отклоняется от фактического значения примерно на `r sprintf("%.0f", mean(abs(filter(customerWinBack, reacquire == 1)$duration_2 - pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) * predict(Ch07.2Dur, newdata = filter(customerWinBack, reacquire == 1)))))` дней. Если бы вместо этого использовали среднее значение `Duration_2` (`r sprintf("%.2f", mean(customerWinBack$duration_2))`) дней уже точно для всех клиентов как *наивное* предсказание для всех вторых сроков жизни, то обнаружилось бы, что MAD1  около `r sprintf("%.0f", mean(abs(customerWinBack$duration_2 - mean(customerWinBack$duration_2))))` дней. Очевидно, авторская модель значительно улучшает работу по прогнозированию продолжительности взаимоотношений с клиентами, чем по *наивной* модели.

### Как это использовать?

Благодаря этой двухэтапной модели менеджмент может точнее прогнозировать продолжительность сотрудничества с возвращенными клиентов, что существенно улучшает аккуратность планирования доходов от поступлений "старых" потребителей. При этом руководство может четко представлять драйверы, которые влияют на продолжительность второго цикла жизни повторно привлеченных клиентов.

## Модель *CLV второго цикла жизни*

Третий этап этого процесса - оценить модель *вторичного CLV*. Цель этой модели - понять драйверы, которые описывают ожидаемое значение стоимости жизни клиента на втором цикле сотрудничества с фирмой. Таким образом, уравнение принимает следующий формат:

$$ \displaystyle \large E(SCLV) = P(Reacquisition = 1) * E(SCLV | Reacquisition = 1, E( Duration \text _ 2 )). \hspace{.5 in} [6] $$

Это уравнение показывает, что ожидаемый SCLV является функцией вероятности того, что клиент будет восстановлен, умноженный на ожидаемое значение SCLV, учитывая, что клиент был привлечен повторно и оценка вторичной продолжительности отношений клиента с фирмой. Опять же, если бы просто выполнять регрессию с SCLV в качестве зависимой переменной и игнорировали вероятность того, что клиент будет повторно приобретен и оцененная вторичная продолжительность, то можно получить смещенные оценки из-за возможного смещения выборки.

Наконец, авторы сформировали регрессионную модель для `SCLV` и решили оценить ее включая переменные $\lambda$ и $E( Duration \text _ 2 )$ в качестве дополнительных независимых переменных. Это делается простым способом, используя следующее уравнение:

$$ \displaystyle \large SCLV = \gamma' \alpha + \mu \lambda + \rho Durâtion \text _ 2 + \varepsilon. \hspace{.5 in} [7] $$

В этом случае `SCLV` - это значение*CLV второго цикла жизни*;

- $\gamma$ - матрица переменных, используемых для объяснения значения `SCLV`;

- $\alpha$ - коэффициенты для независимых переменных (предикторов);

- $\mu$ - коэффициент обратного отношения Миллса;

- $\lambda$ - обратное отношение Миллса;

- $\rho$ - коэффициент ожидаемой вторичной продолжительности жизни клиента;

- *Duration_2* - ожидаемая вторичная длительность жизни клиента;

- $\varepsilon$ - случайная ошибка модели.

Таким образом, для этого примера мы будем использовать следующий список переменных:

| Переменные      | Описание                                                                             |
|:--------------- |:-------------------------------------------------------------------------------------|
| **Зависимая переменная** |  |
| SCLV            | Прогноз ценности клиента на втором цикле жизни. Это **0**, если клиента не зашел вновь |
| **Предикторы**          |  |
| Duration_1      | Время в днях, когда клиент оставался активным на первом цикле сотрудничества с фирмой |
| Offer           | Стоимость предложения, предоставленного клиенту для повторного привлечения |
| Duration_lapse  | Время в днях, между тем как клиент ушел в отток и затем получив предложение о возвращении |
| Gender          | **1**, если клиент является мужчиной, **0**, если клиент является женщиной |
| Age             | Возраст клиента на момент получения предложение о возвращении к сотрудничеству с фирмой |
| *Lambda* ($\lambda$) | Рассчитанное *обратное отношение Миллса* из модели повторного привлечения клиента |
| Duration_2      | Время в днях, когда клиент стал вторично активным или продолжает быть клиентом |

Когда авторы оценивали третий этап модели возвращения клиентов, они получили следующие оценки параметров (оценки параметров для модели *повторного привлечения* подробно описаны в первой части этого примера, а оценки параметров модели *вторичной длительности* подробно описаны во второй части):

```{r Ch07: SCLV Model}
# Fit Linear Regression Model for SCLV by Authors
# https://stats.idre.ucla.edu/sas/webbooks/reg/

# SAS Code: pred_dur2 = probnorm(xb_probit)*(xbeta_duration2);
pred_dur2 <- pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) *
               predict(Ch07.2Dur, newdata = filter(customerWinBack, reacquire == 1))

(Ch07.SCLV <- lm(sclv ~ duration_1 + offer + price_change + gender + age + imr_win + pred_dur2,
                 data = filter(customerWinBack, reacquire == 1) )) %>%
  summary

writeLines("Variance Inflation Factors - if vif() > 2  - feature has multicollinearity with others")
car::vif(Ch07.SCLV) # Variance Inflation Factors - if vif() > 2 - feature has multicollinearity 

```

Авторы получают вышеуказанные результаты. Очевидно, что $\lambda$ (`pred_dur2`) является положительным и значимым. Это означает, что существует потенциальная проблема *смещения выбора*, поскольку коэффициент ошибки нашего уравнения выбора положительно коррелирует с погрешностью нашего уравнения регрессии. Также видно, что все другие предикторы модели *SCLV* являются значимыми, что означает, что мы, вероятно, обнаружили многие из драйверов вторичного жизненного цикла клиента.

### Как это использовать?

При этом `Duration_1` является положительным, поэтому можно предположить, что чем дольше длительность первого цикла, тем выше ожидаемый размер `SCLV`. Из модели видно, что чем выше `Offer`, предоставляемый клиенту для повторного привлечения, тем выше ожидаемый `SCLV`. Мы находим, что когда цена, которую клиент платит за продукт во втором периоде жизни, ниже (`Price_Change < 0`), то `SCLV` выше. Обнаруживается, что клиенты, которые являются мужчинами или молодыми, с большей вероятностью имеют более высокий `SCLV`. Наконец, мы находим, что коэффициент ожидаемой вторичной продолжительности - положительный, что предполагает, что клиенты, которые возвратились к сотрудничеству во второй раз, более склонны к принесению значительной прибыли.

### Оценка точности модели *CLV второго цикла жизни*

Следующий шаг - предсказать значение `SCLV`, чтобы увидеть, насколько хорошо авторская модель сравнивается с фактическими значениями. Это делается, начиная с уравнений для ожидаемого SCLV в начале этого примера:

$$ \displaystyle \large E(SCLV) = P(Reacquisition = 1) * E(SCLV | Reacquisition = 1, E( Duration \text _ 2 )) = Ф(X' \beta) * \gamma' \alpha + \mu \lambda + \rho Durâtion \text _ 2 + \varepsilon . \hspace{.5 in} [7] $$


```{r Ch06 : Error of SCLV Model}
# Computing the Mean Absolute Deviation (MAD) and Mean Absolute Percent Error (MAPE)
# SAS Code: pred_sclv = probnorm(xb_probit)*(xbeta_sclv);

with(filter(customerWinBack, reacquire == 1), {
  pred_sclv <- pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) *
               predict(Ch07.SCLV, newdata = filter(customerWinBack, reacquire == 1))
  # mad = mean(abs(abs(sclv - pred_sclv));
  writeLines(sprintf("Mean Absolute Deviation (MAD): %.2f долл.", mean(abs(sclv - pred_sclv))))
  
  # mape = mean(abs(sclv - pred_sclv)/sclv);
  writeLines(sprintf("Mean Absolute Percent Error (MAPE): %.3f %% \n", mean(abs(sclv - pred_sclv) /
                                                                              sclv) * 100))
})

with(customerWinBack, {
  writeLines(sprintf("Mean `SCLV` for Naive Model: %.2f долл. \n", mean(sclv)))
  
  # mad1 = mean(abs(sclv - mean(sclv));
  mad1 <- mean(abs(sclv - mean(sclv)))
  writeLines(sprintf("Naive Mean Absolute Deviation (MAD1): %.2f долл.", mad1))
  
  # mape1 = mean(abs(sclv - mean(sclv))/sclv);
  mape1 <- mean(abs(sclv - mean(sclv)) / sclv) * 100
  writeLines(sprintf("Naive Mean Absolute Percent Error (MAPE1): %.3f %%", mape1))
  
  })
```

В **R** авторская модель по клиентам, откливнувшимся на кампанию **Winback** получила среднюю абсолютную ошибку `r sprintf("%.2f", mean(abs(filter(customerWinBack, reacquire == 1)$sclv - pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) * predict(Ch07.SCLV, newdata = filter(customerWinBack, reacquire == 1)))))` долл. (хотя авторы написали, что это относится ко всем клиентам, но ведь сама авторская модель строилась на фильтре данных `reacquire == 1`) . Это означает, что в среднем каждое из авторских предсказаний значения SCLV отклоняется от фактического значения примерно на `r sprintf("%.0f", mean(abs(filter(customerWinBack, reacquire == 1)$sclv - pnorm(xbeta[ifelse(customerWinBack$reacquire == 1, TRUE, FALSE)]) * predict(Ch07.SCLV, newdata = filter(customerWinBack, reacquire == 1)))))` долл. Если бы авторы вместо своей модели использовали среднее значение SCLV (`r sprintf("%.2f", mean(customerWinBack$sclv))` долл.) для всех клиентов в качестве *наивного прогноза*, то обнаружилась бы, что MAD = `r sprintf("%.2f", mean(abs(customerWinBack$sclv - mean(customerWinBack$sclv))))` долл.. Очевидно, что авторская регрессионая модель значительно улучшает работу по предсказанию ожидаемой прибыли клиентов, чем к *наивная*.

---

```{r The end of session}

devtools::session_info()

```

## Выводы по главе 7

Цель этой главы состояла в том, чтобы изучить текущие модели возвращения клиентов и представить эмпирический пример того, как фирмы могут применять эти знания на своих клиентских базах данных. Авторы показали, что, когда фирмы могут сначала понять движущие силы возвращения клиентов, продолжительность обслуживания клиентов в течение второго цикла и рентабельность клиентов второго цикла, фирмы могут более взвешенно принимать стратегические решения о том, какие клиенты попытаются вернуться и какой уровень предложений предлагать, чтобы предоставить от этих клиентам максимальную рентабельность фирме.
